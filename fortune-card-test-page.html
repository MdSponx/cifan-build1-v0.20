<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÆ Fortune Card Upload Test Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .test-card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-card .emoji {
            font-size: 1.5rem;
        }

        .test-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-button.success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .test-button.warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }

        .test-button.info {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .console-output {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .console-output .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .console-output .log-success {
            color: #00ff88;
        }

        .console-output .log-error {
            color: #ff6b6b;
        }

        .console-output .log-warning {
            color: #ffd93d;
        }

        .console-output .log-info {
            color: #74b9ff;
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-upload-area.dragover {
            border-color: #74b9ff;
            background: rgba(116, 185, 255, 0.1);
        }

        .file-input {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        .status-error {
            background: #ff6b6b;
            box-shadow: 0 0 10px #ff6b6b;
        }

        .status-warning {
            background: #ffd93d;
            box-shadow: 0 0 10px #ffd93d;
        }

        .status-pending {
            background: #74b9ff;
            box-shadow: 0 0 10px #74b9ff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .results-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-item .result-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #74b9ff, #0984e3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .firebase-config {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .config-item {
            margin-bottom: 5px;
        }

        .config-label {
            color: #ffd93d;
            font-weight: bold;
        }

        .config-value {
            color: #74b9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÆ Fortune Card Upload Test Suite</h1>
            <p>Comprehensive testing for CIFAN 2025 Fortune Card upload functionality</p>
        </div>

        <!-- Firebase Configuration Display -->
        <div class="firebase-config">
            <h4>üî• Firebase Configuration Status</h4>
            <div id="firebase-status">
                <div class="config-item">
                    <span class="config-label">Firebase SDK:</span>
                    <span class="config-value" id="firebase-sdk-status">Checking...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Authentication:</span>
                    <span class="config-value" id="auth-status">Checking...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Storage:</span>
                    <span class="config-value" id="storage-status">Checking...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">User Role:</span>
                    <span class="config-value" id="user-role">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Test Cards Grid -->
        <div class="test-grid">
            <!-- Quick Test Card -->
            <div class="test-card">
                <h3><span class="emoji">‚ö°</span>Quick Test</h3>
                <p>Run all tests automatically with a single click</p>
                <button class="test-button" id="quick-test-btn" onclick="runQuickTest()">
                    <span class="status-indicator status-pending" id="quick-test-status"></span>
                    Run All Tests
                </button>
                <div class="progress-bar">
                    <div class="progress-fill" id="quick-test-progress"></div>
                </div>
            </div>

            <!-- Firebase Connection Test -->
            <div class="test-card">
                <h3><span class="emoji">üî•</span>Firebase Connection</h3>
                <p>Test Firebase SDK loading and authentication</p>
                <button class="test-button info" onclick="testFirebaseConnection()">
                    <span class="status-indicator status-pending" id="firebase-status-indicator"></span>
                    Test Firebase
                </button>
            </div>

            <!-- File Upload Test -->
            <div class="test-card">
                <h3><span class="emoji">üìÅ</span>File Upload</h3>
                <p>Test file selection and upload to Firebase Storage</p>
                <div class="file-upload-area" id="file-upload-area" onclick="document.getElementById('file-input').click()">
                    <p>Click or drag & drop a fortune card image</p>
                    <input type="file" id="file-input" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                    <div id="file-preview"></div>
                </div>
                <button class="test-button success" id="upload-test-btn" onclick="testFileUpload()" disabled>
                    <span class="status-indicator status-pending" id="upload-status-indicator"></span>
                    Test Upload
                </button>
            </div>

            <!-- Storage Rules Test -->
            <div class="test-card">
                <h3><span class="emoji">üîí</span>Storage Rules</h3>
                <p>Verify Firebase Storage security rules</p>
                <button class="test-button warning" onclick="testStorageRules()">
                    <span class="status-indicator status-pending" id="rules-status-indicator"></span>
                    Test Rules
                </button>
            </div>

            <!-- Form Integration Test -->
            <div class="test-card">
                <h3><span class="emoji">üìù</span>Form Integration</h3>
                <p>Test complete form data flow simulation</p>
                <button class="test-button info" onclick="testFormIntegration()">
                    <span class="status-indicator status-pending" id="form-status-indicator"></span>
                    Test Form Flow
                </button>
            </div>

            <!-- Database Test -->
            <div class="test-card">
                <h3><span class="emoji">üíæ</span>Database Save</h3>
                <p>Test saving fortune card URL to Firestore</p>
                <button class="test-button success" onclick="testDatabaseSave()">
                    <span class="status-indicator status-pending" id="db-status-indicator"></span>
                    Test Database
                </button>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary">
            <h3>üìä Test Results Summary</h3>
            <div class="results-grid">
                <div class="result-item">
                    <div class="result-value" id="tests-passed">0</div>
                    <div class="result-label">Tests Passed</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="tests-failed">0</div>
                    <div class="result-label">Tests Failed</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="upload-speed">0 KB/s</div>
                    <div class="result-label">Upload Speed</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="total-time">0s</div>
                    <div class="result-label">Total Time</div>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="console-output" id="console-output">
            <div class="log-entry log-info">üîÆ Fortune Card Test Suite initialized</div>
            <div class="log-entry log-info">üí° Click any test button to begin testing</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Test Script -->
    <script src="test-fortune-card-upload-complete.js"></script>

    <script>
        // Global test state
        let testState = {
            selectedFile: null,
            uploadedUrl: null,
            testResults: {
                passed: 0,
                failed: 0,
                startTime: null,
                uploadSpeed: 0
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Initializing Fortune Card Test Page', 'info');
            checkFirebaseStatus();
            setupDragAndDrop();
        });

        // Logging function
        function log(message, type = 'info') {
            const console = document.getElementById('console-output');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
            
            // Also log to browser console
            console[type === 'error' ? 'error' : 'log'](message);
        }

        // Update status indicator
        function updateStatus(elementId, status) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // Update progress bar
        function updateProgress(elementId, percentage) {
            const progressBar = document.getElementById(elementId);
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
        }

        // Check Firebase status
        function checkFirebaseStatus() {
            log('üîç Checking Firebase configuration...', 'info');
            
            // Check Firebase SDK
            if (typeof firebase !== 'undefined') {
                document.getElementById('firebase-sdk-status').textContent = '‚úÖ Loaded';
                log('‚úÖ Firebase SDK loaded successfully', 'success');
            } else {
                document.getElementById('firebase-sdk-status').textContent = '‚ùå Not loaded';
                log('‚ùå Firebase SDK not loaded', 'error');
                return;
            }

            // Check Authentication
            try {
                const auth = firebase.auth();
                const user = auth.currentUser;
                
                if (user) {
                    document.getElementById('auth-status').textContent = `‚úÖ ${user.email}`;
                    document.getElementById('user-role').textContent = 'üîç Checking...';
                    log(`‚úÖ User authenticated: ${user.email}`, 'success');
                    
                    // Check user role (if available)
                    checkUserRole(user.uid);
                } else {
                    document.getElementById('auth-status').textContent = '‚ùå Not authenticated';
                    log('‚ùå User not authenticated - please log in', 'warning');
                }
            } catch (error) {
                document.getElementById('auth-status').textContent = '‚ùå Error';
                log(`‚ùå Authentication error: ${error.message}`, 'error');
            }

            // Check Storage
            try {
                const storage = firebase.storage();
                document.getElementById('storage-status').textContent = '‚úÖ Available';
                log('‚úÖ Firebase Storage available', 'success');
            } catch (error) {
                document.getElementById('storage-status').textContent = '‚ùå Error';
                log(`‚ùå Storage error: ${error.message}`, 'error');
            }
        }

        // Check user role
        async function checkUserRole(userId) {
            try {
                const db = firebase.firestore();
                const profileDoc = await db.collection('profiles').doc(userId).get();
                
                if (profileDoc.exists) {
                    const role = profileDoc.data().role || 'user';
                    document.getElementById('user-role').textContent = `üë§ ${role}`;
                    log(`üë§ User role: ${role}`, 'info');
                } else {
                    document.getElementById('user-role').textContent = '‚ùì Unknown';
                    log('‚ùì User role not found', 'warning');
                }
            } catch (error) {
                document.getElementById('user-role').textContent = '‚ùå Error';
                log(`‚ùå Role check error: ${error.message}`, 'error');
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('file-upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                const imageFile = files.find(file => file.type.startsWith('image/'));
                
                if (imageFile) {
                    handleFileSelect({ target: { files: [imageFile] } });
                } else {
                    log('‚ùå Please drop an image file', 'error');
                }
            });
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            log(`üìÅ File selected: ${file.name} (${formatFileSize(file.size)})`, 'info');
            testState.selectedFile = file;

            // Show preview
            const preview = document.getElementById('file-preview');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Preview">`;
            };
            
            reader.readAsDataURL(file);

            // Enable upload button
            document.getElementById('upload-test-btn').disabled = false;
            updateStatus('upload-status-indicator', 'pending');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            log('üî• Testing Firebase connection...', 'info');
            updateStatus('firebase-status-indicator', 'pending');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }
                
                const auth = firebase.auth();
                const user = auth.currentUser;
                
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                const storage = firebase.storage();
                const testRef = storage.ref('test-connection');
                
                log('‚úÖ Firebase connection test passed', 'success');
                updateStatus('firebase-status-indicator', 'success');
                testState.testResults.passed++;
                updateTestResults();
                
            } catch (error) {
                log(`‚ùå Firebase connection test failed: ${error.message}`, 'error');
                updateStatus('firebase-status-indicator', 'error');
                testState.testResults.failed++;
                updateTestResults();
            }
        }

        // Test file upload
        async function testFileUpload() {
            if (!testState.selectedFile) {
                log('‚ùå No file selected for upload test', 'error');
                return;
            }

            log('üì§ Testing file upload...', 'info');
            updateStatus('upload-status-indicator', 'pending');
            
            const startTime = Date.now();
            
            try {
                const storage = firebase.storage();
                const timestamp = Date.now();
                const fileName = `test-${timestamp}-${testState.selectedFile.name}`;
                const path = `films/user_uploads/fortune_cards/${fileName}`;
                const storageRef = storage.ref(path);
                
                log(`üìÅ Uploading to: ${path}`, 'info');
                
                const uploadTask = storageRef.put(testState.selectedFile);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateProgress('quick-test-progress', progress);
                        log(`üìä Upload progress: ${Math.round(progress)}%`, 'info');
                    },
                    (error) => {
                        log(`‚ùå Upload failed: ${error.message}`, 'error');
                        updateStatus('upload-status-indicator', 'error');
                        testState.testResults.failed++;
                        updateTestResults();
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const endTime = Date.now();
                            const uploadTime = (endTime - startTime) / 1000;
                            const uploadSpeed = (testState.selectedFile.size / 1024) / uploadTime;
                            
                            testState.uploadedUrl = downloadURL;
                            testState.testResults.uploadSpeed = uploadSpeed;
                            
                            log(`‚úÖ Upload completed successfully`, 'success');
                            log(`üîó Download URL: ${downloadURL}`, 'info');
                            log(`‚ö° Upload speed: ${uploadSpeed.toFixed(2)} KB/s`, 'info');
                            
                            updateStatus('upload-status-indicator', 'success');
                            testState.testResults.passed++;
                            updateTestResults();
                            
                            // Clean up test file
                            try {
                                await uploadTask.snapshot.ref.delete();
                                log('üßπ Test file cleaned up', 'info');
                            } catch (cleanupError) {
                                log(`‚ö†Ô∏è Could not clean up test file: ${cleanupError.message}`, 'warning');
                            }
                            
                        } catch (urlError) {
                            log(`‚ùå Error getting download URL: ${urlError.message}`, 'error');
                            updateStatus('upload-status-indicator', 'error');
                            testState.testResults.failed++;
                            updateTestResults();
                        }
                    }
                );
                
            } catch (error) {
                log(`‚ùå Upload test failed: ${error.message}`, 'error');
                updateStatus('upload-status-indicator', 'error');
                testState.testResults.failed++;
                updateTestResults();
            }
        }

        // Test storage rules
        async function testStorageRules() {
            log('üîí Testing Firebase Storage rules...', 'info');
            updateStatus('rules-status-indicator', 'pending');
            
            try {
                // Create a small test file
                const testBlob = new Blob(['test'], { type: 'text/plain' });
                const testFile = new File([testBlob], 'rules-test.txt', { type: 'text/plain' });
                
                const storage = firebase.storage();
                const testPath = `films/user_uploads/fortune_cards/rules-test-${Date.now()}.txt`;
                const storageRef = storage.ref(testPath);
                
                // Test upload permission
                await storageRef.put(testFile);
                log('‚úÖ Storage rules allow upload', 'success');
                
                // Test read permission
                const downloadURL = await storageRef.getDownloadURL();
                log('‚úÖ Storage rules allow read access', 'success');
                
                // Clean up
                await storageRef.delete();
                log('üßπ Test file cleaned up', 'info');
                
                updateStatus('rules-status-indicator', 'success');
                testState.testResults.passed++;
                updateTestResults();
                
            } catch (error) {
                log(`‚ùå Storage rules test failed: ${error.message}`, 'error');
                updateStatus('rules-status-indicator', 'error');
                testState.testResults.failed++;
                updateTestResults();
            }
        }

        // Test form integration
        function testFormIntegration() {
            log('üìù Testing form integration...', 'info');
            updateStatus('form-status-indicator', 'pending');
            
            try {
                // Simulate form data
                const formData = {
                    titleEn: 'Test Film for Fortune Card',
                    director: 'Test Director',
                    category: 'Official Selection',
                    genres: ['Drama'],
                    countries: ['Thailand'],
                    languages: ['Thai'],
                    logline: 'A test film for fortune card upload',
                    synopsis: 'This is a test film created to verify fortune card upload functionality.',
                    timeEstimate: '‡∏Ñ‡πà‡∏≥',
                    theatre: 'Theatre 1',
                    status: '‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö / Accepted',
                    publicationStatus: 'draft',
                    fortuneCardFile: testState.selectedFile,
                    fortuneCard: testState.uploadedUrl,
                    fortuneCardUrl: testState.uploadedUrl
                };
                
                log('üìã Form data prepared successfully', 'success');
                log(`üìÅ Has fortune card file: ${!!formData.fortuneCardFile}`, 'info');
                log(`üîó Has fortune card URL: ${!!formData.fortuneCard}`, 'info');
                
                // Test data cleaning (simulate helpers)
                const cleanedData = {};
                Object.entries(formData).forEach(([key, value]) => {
                    if (value !== undefined && 
                        key !== 'id' && 
                        key !== 'createdAt' && 
                        key !== 'createdBy' && 
                        key !== 'updatedAt') {
                        cleanedData[key] = value;
                    }
                });
                
                log('üßπ Data cleaning simulation passed', 'success');
                
                // Test service preparation (simulate prepareFilmDataForFirestore)
                const { fortuneCardFile, ...serviceData } = cleanedData;
                
                if (!serviceData.fortuneCard) {
                    throw new Error('fortuneCard field missing in final data');
                }
                
                if (serviceData.fortuneCardFile) {
                    throw new Error('fortuneCardFile should be removed from service data');
                }
                
                log('‚úÖ Form integration test passed', 'success');
                updateStatus('form-status-indicator', 'success');
                testState.testResults.passed++;
                updateTestResults();
                
            } catch (error) {
                log(`‚ùå Form integration test failed: ${error.message}`, 'error');
                updateStatus('form-status-indicator', 'error');
                testState.testResults.failed++;
                updateTestResults();
            }
        }

        // Test database save
        async function testDatabaseSave() {
            log('üíæ Testing database save...', 'info');
            updateStatus('db-status-indicator', 'pending');
            
            try {
                if (!testState.uploadedUrl) {
                    throw new Error('No uploaded URL available for database test');
                }
                
                const db = firebase.firestore();
                const testDoc = db.collection('test-films').doc(`test-${Date.now()}`);
                
                const testData = {
                    titleEn: 'Test Film for Fortune Card Database',
                    fortuneCard: testState.uploadedUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    testDocument: true
                };
                
                await testDoc.set(testData);
                log('‚úÖ Test document created in Firestore', 'success');
                
                // Verify the data was saved
                const savedDoc = await testDoc.get();
                if (savedDoc.exists && savedDoc.data().fortuneCard === testState.uploadedUrl) {
                    log('‚úÖ Fortune card URL verified in database', 'success');
                    updateStatus('db-status-indicator', 'success');
                    testState.testResults.passed++;
                    updateTestResults();
                    
                    // Clean up test document
                    try {
                        await testDoc.delete();
                        log('üßπ Test document cleaned up', 'info');
                    } catch (cleanupError) {
                        log(`‚ö†Ô∏è Could not clean up test document: ${cleanupError.message}`, 'warning');
                    }
                } else {
                    throw new Error('Fortune card URL not found in saved document');
                }
                
            } catch (error) {
                log(`‚ùå Database save test failed: ${error.message}`, 'error');
                updateStatus('db-status-indicator', 'error');
                testState.testResults.failed++;
                updateTestResults();
            }
        }

        // Update test results display
        function updateTestResults() {
            document.getElementById('tests-passed').textContent = testState.testResults.passed;
            document.getElementById('tests-failed').textContent = testState.testResults.failed;
            document.getElementById('upload-speed').textContent = `${testState.testResults.uploadSpeed.toFixed(1)} KB/s`;
            
            if (testState.testResults.startTime) {
                const totalTime = (Date.now() - testState.testResults.startTime) / 1000;
                document.getElementById('total-time').textContent = `${totalTime.toFixed(1)}s`;
            }
        }

        // Run quick test (all tests)
        async function runQuickTest() {
            log('‚ö° Starting quick test suite...', 'info');
            updateStatus('quick-test-status', 'pending');
            testState.testResults.startTime = Date.now();
            testState.testResults.passed = 0;
            testState.testResults.failed = 0;
            
            try {
                // Test 1: Firebase Connection
                await testFirebaseConnection();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Test 2: Storage Rules
                await testStorageRules();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Test 3: Form Integration (if file selected)
                if (testState.selectedFile) {
                    testFormIntegration();
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Test 4: File Upload
                    await testFileUpload();
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Test 5: Database Save
                    if (testState.uploadedUrl) {
                        await testDatabaseSave();
                    }
                } else {
                    log('‚ö†Ô∏è No file selected - skipping upload and database tests', 'warning');
                }
                
                // Final results
                const totalTests = testState.testResults.passed + testState.testResults.failed;
                const successRate = totalTests > 0 ? (testState.testResults.passed / totalTests * 100).toFixed(1) : 0;
                
                if (testState.testResults.failed === 0) {
                    log(`üéâ All tests passed! Success rate: ${successRate}%`, 'success');
                    updateStatus('quick-test-status', 'success');
                } else {
                    log(`‚ö†Ô∏è Some tests failed. Success rate: ${successRate}%`, 'warning');
                    updateStatus('quick-test-status', 'warning');
                }
                
                updateProgress('quick-test-progress', 100);
                
            } catch (error) {
                log(`‚ùå Quick test suite failed: ${error.message}`, 'error');
                updateStatus('quick-test-status', 'error');
            }
        }

        // Auto-create test file if none selected
        async function createTestFile() {
            log('üé® Creating test fortune card image...', 'info');
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 400;
                
                const ctx = canvas.getContext('2d');
                
                // Create gradient background
                const gradient = ctx.createLinearGradient(0, 0, 600, 400);
                gradient.addColorStop(0, '#8B5CF6'); // Purple
                gradient.addColorStop(0.5, '#EC4899'); // Pink
                gradient.addColorStop(1, '#F59E0B'); // Amber
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 600, 400);
                
                // Add mystical elements
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * 600;
                    const y = Math.random() * 400;
                    const radius = Math.random() * 3 + 1;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Add text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.fillText('üîÆ Fortune Card', 300, 150);
                
                ctx.font = 'bold 20px Arial';
                ctx.fillText('Test Image', 300, 190);
                
                ctx.font = '16px Arial';
                ctx.fillText(new Date().toLocaleString(), 300, 220);
                
                ctx.font = '14px Arial';
                ctx.fillText('CIFAN 2025 Film Festival', 300, 250);
                
                // Convert to file
                return new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        const file = new File([blob], `fortune-card-test-${Date.now()}.png`, {
                            type: 'image/png',
                            lastModified: Date.now()
                        });
                        
                        log(`‚úÖ Test file created: ${file.name} (${formatFileSize(file.size)})`, 'success');
                        resolve(file);
                    }, 'image/png', 0.9);
                });
                
            } catch (error) {
                log(`‚ùå Error creating test file: ${error.message}`, 'error');
                return null;
            }
        }

        // Auto-create test file for quick test if none selected
        document.getElementById('quick-test-btn').addEventListener('click', async function() {
            if (!testState.selectedFile) {
                log('üìÅ No file selected, creating test file...', 'info');
                const testFile = await createTestFile();
                if (testFile) {
                    testState.selectedFile = testFile;
                    
                    // Show preview
                    const preview = document.getElementById('file-preview');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Test Preview">`;
                    };
                    reader.readAsDataURL(testFile);
                    
                    // Enable upload button
                    document.getElementById('upload-test-btn').disabled = false;
                }
            }
        });
    </script>
</body>
</html>
